<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. Installation d&#39;un Service Worker | PWA Workshop</title>
    <meta name="description" content="Introduction aux Progressive Web Applications">
    <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.aa2ecf69.css" as="style"><link rel="preload" href="/assets/js/app.d9dc9a76.js" as="script"><link rel="preload" href="/assets/js/3.c69d9a44.js" as="script"><link rel="preload" href="/assets/js/7.a2e3be9a.js" as="script"><link rel="prefetch" href="/assets/js/1.70248c23.js"><link rel="prefetch" href="/assets/js/10.4a2f255d.js"><link rel="prefetch" href="/assets/js/11.27680d75.js"><link rel="prefetch" href="/assets/js/12.3eef7c77.js"><link rel="prefetch" href="/assets/js/13.7f52cf31.js"><link rel="prefetch" href="/assets/js/14.375a1e21.js"><link rel="prefetch" href="/assets/js/15.349dce31.js"><link rel="prefetch" href="/assets/js/16.5c7d3d8b.js"><link rel="prefetch" href="/assets/js/17.b0821c4d.js"><link rel="prefetch" href="/assets/js/18.b5485965.js"><link rel="prefetch" href="/assets/js/19.f2ff2149.js"><link rel="prefetch" href="/assets/js/20.2fc7ff0c.js"><link rel="prefetch" href="/assets/js/21.02740876.js"><link rel="prefetch" href="/assets/js/22.6ed05f9f.js"><link rel="prefetch" href="/assets/js/23.cb63fa5d.js"><link rel="prefetch" href="/assets/js/24.e5dfe154.js"><link rel="prefetch" href="/assets/js/4.15820eac.js"><link rel="prefetch" href="/assets/js/5.fba207a2.js"><link rel="prefetch" href="/assets/js/6.e17a1400.js"><link rel="prefetch" href="/assets/js/8.8f8d29be.js"><link rel="prefetch" href="/assets/js/9.363b16b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aa2ecf69.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fr/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/2-service-worker/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/fr/2-service-worker/" class="nav-link router-link-exact-active router-link-active">Français</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Langue</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/2-service-worker/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/fr/2-service-worker/" class="nav-link router-link-exact-active router-link-active">Français</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/fr/" class="sidebar-link">Introduction</a></li><li><a href="/fr/1-manifest/" class="sidebar-link">1. Ajout d'un Web App Manifest</a></li><li><a href="/fr/2-service-worker/" class="active sidebar-link">2. Installation d'un Service Worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#introduction-aux-web-worker" class="sidebar-link">Introduction aux Web Worker</a></li><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#ajout-d-un-service-worker" class="sidebar-link">Ajout d'un Service Worker</a></li><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#enregistrement-du-service-worker" class="sidebar-link">Enregistrement du Service Worker</a></li><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#cycle-de-vie-du-service-worker" class="sidebar-link">Cycle de vie du Service Worker</a></li><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#bibliotheque-de-compatibilite-pwa" class="sidebar-link">bibliothèque de compatibilité PWA</a></li><li class="sidebar-sub-header"><a href="/fr/2-service-worker/#developpement-local-avec-ssl" class="sidebar-link">Développement local avec SSL</a></li></ul></li><li><a href="/fr/3-precaching/" class="sidebar-link">3. Precaching et mode offline basique</a></li><li><a href="/fr/4-api-cache/" class="sidebar-link">4. Stratégie de Cache pour API REST</a></li><li><a href="/fr/5-background-sync/" class="sidebar-link">5. Background sync et notifications</a></li><li><a href="/fr/6-pwa-setup/" class="sidebar-link">6. Présentation de l'invite d'installation</a></li><li><a href="/fr/finish.html" class="sidebar-link">Pour aller plus loin</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="etape-2-installation-d-un-service-worker"><a href="#etape-2-installation-d-un-service-worker" class="header-anchor">#</a> Etape 2 : Installation d'un Service Worker</h1> <p>Avant de nous lancer dans les Services Workers, regardons d'abord en quoi consiste les Web Worker.</p> <h2 id="introduction-aux-web-worker"><a href="#introduction-aux-web-worker" class="header-anchor">#</a> Introduction aux Web Worker</h2> <p>Comme vous le savez peut-être, JavaScript est à thread unique et ne permet pas la création de nouveaux threads.
Un Web Workers permet d'exécuter du code dans un thread séparé pour une utilisation générale.
Le code du worker réside généralement dans un fichier JavaScript distinct du code JavaScript principal.
Après avoir créé le Web Worker, nous avons deux threads JavaScript: celui du JavaScript principal et celui du Web Worker.
Une fois le worker créé, il peut interagir avec le code JavaScript principal de manière bidirectionnelle à l'aide de la fonction <code>postMessage</code> et de l'évènement <code>message</code>.</p> <p>Étant donné que le travailleur Web dispose de son propre thread, il peut effectuer des tâches exigeant beaucoup de processus sans geler la page.</p> <p>Voici une page Web minimale qui a créé un agent de service et qui communique avec lui.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Web Worker example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendMessageToWorker()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Post message to worker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>askWorkerToPerformRecurringTask()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Launch recurring task<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Worker result<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Voici le code qui crée le worker et qui communique avec lui.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// crate a worker whose code is defined in the file passed as parameter</span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;worker.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">askWorkerToPerformRecurringTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// post a sting to the worker</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recurring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">sendMessageToWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// post a sting to the worker</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This event is fired when the worker posts a message</span>
<span class="token comment">// The value of the message is in messageEvent.data</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">messageEvent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Log the received message on the top of the tag</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> messageEvent<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">&quot;&lt;br&gt;&quot;</span> <span class="token operator">+</span> div<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Enfin, voici le code du Web Worker qui réagit au message reçu du JS principal en publiant un seul message ou en affichant un nombre aléatoire toutes les secondes.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a function that generates a random number every second and posts it to the main JavaScript</span>
<span class="token keyword">function</span> <span class="token function">generateNumbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// post a message to the main JavaScript</span>
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This event is fired when the worker recieves a message from the main JavaScript</span>
<span class="token comment">// The value of the message is in messageEvent.data</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">messageEvent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>messageEvent<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">&quot;recurring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// If the value of the event is &quot;recurring&quot;, we launch the above function</span>
        <span class="token function">generateNumbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// Post a message back to the main JS</span>
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello to you too !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Vous pouvez essayer cette page <a href="https://pwa-workshop.js.org/samples/worker01/" target="_blank" rel="noopener noreferrer">en suivant ce lien<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Ceci conclut cette introduction courte aux Web Workers.</p> <h2 id="ajout-d-un-service-worker"><a href="#ajout-d-un-service-worker" class="header-anchor">#</a> Ajout d'un Service Worker</h2> <p>Les <a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">Service Workers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> constituent une API assez vaste et présentant beaucoup de potentiel. Dans le cadre d'une PWA, le Service Worker va principalement nous permettre de définir une stratégie de mise en cache et ainsi mieux gérer les connexions capricieuses, voire un mode offline complet pour notre application.</p> <p>Ce que vous devez retenir au sujet des Service Workers:</p> <ul><li>Ce sont des workers codés en JavaScript. Ils s'éxécutent dans un thread distinct du script applicatif et ne peuvent pas accéder au DOM ni aux variables globales, mais l'application peut communiquer avec le worker grâce à l'API <code>postMessage</code>.</li> <li>Ils peuvent être considérés comme des proxy réseau programmables. En effet, ils permettent d'intercepter les requêtes réseau en partance du navigateur et de personnaliser les réponses.</li> <li>Ils ont un cycle de vie indépendant de l'application web associée. Ils s'arrêtent lorsqu'ils ne sont pas utilisés et redémarrent au besoin.</li> <li>Ils peuvent fonctionner sans que l'application web associée tourne, ce qui permet certaines fonctionnalités inédites comme l'envoi de notifications Push.</li> <li>Plusieurs API sont disponibles au sein du Service Worker pour persister les données localement, par exemple l'<a href="https://developer.mozilla.org/fr/docs/Web/API/Cache" target="_blank" rel="noopener noreferrer"><strong>API Cache</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> et l'<a href="https://developer.mozilla.org/fr/docs/Web/API/API_IndexedDB" target="_blank" rel="noopener noreferrer"><strong>API IndexedDB</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>La plupart des API associées sont basées sur l'utilisation des promesses (<a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Promise" target="_blank" rel="noopener noreferrer"><code>Promise</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</li></ul> <p>Dans le dossier <code>app</code>, créez un fichier <code>sw.js</code> vide (pour l'instant). Il contiendra le code de votre Service Worker.</p> <h2 id="enregistrement-du-service-worker"><a href="#enregistrement-du-service-worker" class="header-anchor">#</a> Enregistrement du Service Worker</h2> <p>Avant d'utiliser un Service Worker, il faut le faire enregistrer par l'application. On enregistre généralement le Service Worker au chargement de la page. Dans le fichier <code>scripts.js</code>, complétez la fonction appelée au chargement du document avec le code suivant :</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker
    <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">serviceWorker</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker registered: '</span> <span class="token operator">+</span> serviceWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Error registering the Service Worker: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Rechargez la page, le log suivant devrait apparaitre une fois la page chargée.</p> <div class="language- extra-class"><pre class="language-text"><code>Service Worker registered: [object ServiceWorkerRegistration]
</code></pre></div><p>Cela signifie que le Service Worker a bien été enregistré. On peut vérifier cela en regardant dans l'onglet <strong>Application</strong> des Chrome Developer Tools, puis dans la sous-section <strong>Service Workers</strong>.</p> <p><img src="/assets/img/service-worker-setup.84b2c4b3.png" alt="Service Worker bien installé" title="Cycle de vie du Service Worker"></p> <p>Nous allons voir dans le section qui suite ce qui se passe après l'enregistrement d'un Service Worker.</p> <h2 id="cycle-de-vie-du-service-worker"><a href="#cycle-de-vie-du-service-worker" class="header-anchor">#</a> Cycle de vie du Service Worker</h2> <p>Quand on enregistre un Service Worker, son cycle de vie démarre. Le schéma suivant représente les différentes étapes du cycle de vie d'un Service Worker (<a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">source<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p><img src="/assets/img/sw-lifecycle.1d49eede.png" alt="Cycle de vie du Service Worker" title="Cycle de vie du Service Worker"></p> <p>Les premières étapes sont l'installation et l'activation. Vérifions cela en ajoutant le code suivant dans le fichier <em>sw.js</em>.</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker installing.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker activating.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Rechargez la page et vérifier les logs. Curieusement, on ne voit que le log d'installation.</p> <div class="language- extra-class"><pre class="language-text"><code>Service Worker registered [object ServiceWorkerRegistration]
Service Worker installing.
</code></pre></div><p>Regardons ce qui se passe dans la section Service Worker des Dev Tools. Un affichage similaire à la capture suivante devrait apparaitre:</p> <p><img src="/assets/img/sw-waiting.0b9f4663.png" alt="Service Worker en attente d'installation" title="Service Worker en attente"></p> <p>Quand on rafraîchit la page, le navigateur essaie d'installer puis d'activer le Service Worker avec le nouveau code. Comme ce dernier est différent du Service Worker actif, celui enregistré au début de l'étape 2, l'activation du nouveau Service Worker est suspendue. Dans ce cas, il est mis en attente et ne sera installé que si le précédent Service Worker ne contrôle plus aucun client. On a deux solutions dans ce cas: soit fermer tous les onglets controlés par le premier Service Worker ou bien cliquer sur le lien <strong>skipWaiting</strong> dans les outils développeur.</p> <p>Cliquez sur le lien <strong>skipWaiting</strong>. On remarque que l'ancien Service Worker a disparu et que celui qui était en attente prend sa place. Le log d'activation s'affiche également.</p> <div class="language- extra-class"><pre class="language-text"><code>Service Worker activating.
</code></pre></div><p>Quand on rafraîchit la page sans modifier le Service Worker, on remarque qu'on ne passe plus par les étapes d'installation et d'activation.</p> <p>Ce comportement est nécessaire pour gérer les montées de version des Service Workers en production. En pratique, vous aurez à écrire du code dans le Service Worker pour gérer ce processus de mise à jour et appeler <code>skipWaiting</code> programmatiquement une fois que tout est prêt.</p> <p>Pendant le développement toutefois, on peut s'en passer en cochant la case <strong>Update on reload</strong>. Cette option permet d'activer immédiatement les futurs nouveaux Service Workers. C'est un équivalent d'un clic automatique sur <strong>skipWaiting</strong> à chaque fois.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Activez l'option <strong>Update on reload</strong> lorsque vous travaillez sur le code d'un Service Worker pour toujours disposer de la dernière version.</p> <p><img src="/assets/img/devtools-update-on-reload.d1d00b91.png" alt="Update on reload"></p> <p>Attention toutefois, cette option installera et activera le Service Worker <strong>avant</strong> d'afficher la page, ce qui ne vous permettra pas de voir les logs associés à ces évènements en console.</p></div> <h2 id="bibliotheque-de-compatibilite-pwa"><a href="#bibliotheque-de-compatibilite-pwa" class="header-anchor">#</a> bibliothèque de compatibilité PWA</h2> <p>Comme la technologie Progressive Web Apps est récente et en évolution, certains navigateurs ne supportent pas encore certaines fonctionnalités.
Par exemple, Safari 12 mobile ne prend pas en charge l'écran d’accueil (ou splash-screen).
[pwacomat] (https://github.com/GoogleChromeLabs/pwacompat) de Google Chrome Labs résout ce problème en ajoutant simplement une balise de script dans le fichier html.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/pwacompat@2.0.8/pwacompat.min.js<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sha384-uONtBTCBzHKF84F6XvyC8S0gL8HTkAPeCyBNvfLfsqHh+Kd6s/kaS4BdmNQ5ktp1<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>anonymous<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Nous vous recommandons vivement d’ajouter ce script à vos PWA pour une meilleure compatibilité.</p> <h2 id="developpement-local-avec-ssl"><a href="#developpement-local-avec-ssl" class="header-anchor">#</a> Développement local avec SSL</h2> <p>PWA nécessite l'utilisation de HTTPS. Ce n’est pas problématique pour un PWA déployé car la plupart des hébergeurs supportent HTTPS.
Cependant, ce n'est pas aussi simple pour développement local.
En effet, il faut pour cela générer et installer manuellement des certificats dans le magasin de certificats.
Heureusement, il existe un outil CLI intéressant appelé <a href="https://mkcert.dev/" target="_blank" rel="noopener noreferrer">mkcert<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> qui simplifie ces étapes.</p> <p>Configurons notre serveur HTTPS local en procédant comme suit:</p> <ul><li>Installer <a href="https://github.com/FiloSottile/mkcert#installation" target="_blank" rel="noopener noreferrer">mkcert<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> en suivant les instruction indiquées dans le GitHub</li> <li>Lancer <code>mkcert -install</code> Pour installer une CA (Autorité de certification)</li></ul> <div class="language-console extra-class"><pre class="language-text"><code>Created a new local CA at &quot;/Users/****/Library/Application Support/mkcert&quot; 💥
The local CA is now installed in the system trust store! ⚡️
The local CA is now installed in the Firefox trust store (requires browser restart)! 🦊
</code></pre></div><ul><li>cd jusqu'à la racine du site</li> <li>Lancer cette commande qui génère les certificats pour notre serveur de dev: <code>mkcert localhost 127.0.0.1 ::1</code></li></ul> <div class="language-console extra-class"><pre class="language-text"><code>Using the local CA at &quot;/Users/****yassinebenabbas****/Library/Application Support/mkcert&quot; ✨

Created a new certificate valid for the following names 📜
 - &quot;localhost&quot;
 - &quot;127.0.0.1&quot;
 - &quot;::1&quot;

The certificate is at &quot;./localhost+2.pem&quot; and the key at &quot;./localhost+2-key.pem&quot; ✅
</code></pre></div><ul><li>Nous aurons deux fichiers PEM. Ceux-ci seront utilisés par notre serveur de développement compatible SSL.</li></ul> <p><img src="/assets/img/certs.7e43f7a2.png" alt="certs"></p> <ul><li>Installer la commande <code>http-server</code>. <code>npm i -g http-server</code></li> <li>Lancer le serveur en mode SSL <code>http-server -S -o -C &quot;localhost+2.pem&quot; -K &quot;localhost+2-key.pem&quot;</code></li></ul> <p>Et voilà, on est bien en HTTPs en local. C'est le top !</p> <p><img src="/assets/img/certok.41829eb4.png" alt="certs"></p> <p>Dans cette partie, nous avons vu comment installer un Service Worker.
On a également géré deux évènements du cycle de vie du Service Worker: <strong>install</strong> et <strong>activate</strong>. Nous allons maintenant voir comment faire quelque-chose d'utile avec ce Service Worker.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fr/1-manifest/" class="prev">1. Ajout d'un Web App Manifest</a></span> <span class="next"><a href="/fr/3-precaching/">3. Precaching et mode offline basique</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9dc9a76.js" defer></script><script src="/assets/js/3.c69d9a44.js" defer></script><script src="/assets/js/7.a2e3be9a.js" defer></script>
  </body>
</html>
