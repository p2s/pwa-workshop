<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2. Install a Service Worker | PWA Workshop</title>
    <meta name="description" content="Introduction to Progressive Web Applications">
    <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.aa2ecf69.css" as="style"><link rel="preload" href="/assets/js/app.d9dc9a76.js" as="script"><link rel="preload" href="/assets/js/3.c69d9a44.js" as="script"><link rel="preload" href="/assets/js/5.fba207a2.js" as="script"><link rel="prefetch" href="/assets/js/1.70248c23.js"><link rel="prefetch" href="/assets/js/10.4a2f255d.js"><link rel="prefetch" href="/assets/js/11.27680d75.js"><link rel="prefetch" href="/assets/js/12.3eef7c77.js"><link rel="prefetch" href="/assets/js/13.7f52cf31.js"><link rel="prefetch" href="/assets/js/14.375a1e21.js"><link rel="prefetch" href="/assets/js/15.349dce31.js"><link rel="prefetch" href="/assets/js/16.5c7d3d8b.js"><link rel="prefetch" href="/assets/js/17.b0821c4d.js"><link rel="prefetch" href="/assets/js/18.b5485965.js"><link rel="prefetch" href="/assets/js/19.f2ff2149.js"><link rel="prefetch" href="/assets/js/20.2fc7ff0c.js"><link rel="prefetch" href="/assets/js/21.02740876.js"><link rel="prefetch" href="/assets/js/22.6ed05f9f.js"><link rel="prefetch" href="/assets/js/23.cb63fa5d.js"><link rel="prefetch" href="/assets/js/24.e5dfe154.js"><link rel="prefetch" href="/assets/js/4.15820eac.js"><link rel="prefetch" href="/assets/js/6.e17a1400.js"><link rel="prefetch" href="/assets/js/7.a2e3be9a.js"><link rel="prefetch" href="/assets/js/8.8f8d29be.js"><link rel="prefetch" href="/assets/js/9.363b16b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aa2ecf69.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/2-service-worker/" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/2-service-worker/" class="nav-link">Français</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/2-service-worker/" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/2-service-worker/" class="nav-link">Français</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Adding a Web App Manifest</a></li><li><a href="/2-service-worker/" class="active sidebar-link">2. Install a Service Worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2-service-worker/#introduction-to-web-workers" class="sidebar-link">Introduction to Web workers</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#service-workers" class="sidebar-link">Service workers</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#registering-the-service-worker" class="sidebar-link">Registering the Service Worker</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#service-worker-life-cycle" class="sidebar-link">Service Worker life cycle</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#pwa-compatibility-library" class="sidebar-link">PWA compatibility library</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#local-development-with-ssl" class="sidebar-link">Local development with SSL</a></li></ul></li><li><a href="/3-precaching/" class="sidebar-link">3. Precaching and basic offline mode</a></li><li><a href="/4-api-cache/" class="sidebar-link">4. Cache Strategy for REST API</a></li><li><a href="/5-background-sync/" class="sidebar-link">5. Background sync and notifications</a></li><li><a href="/6-pwa-setup/" class="sidebar-link">6. Showing the install button prompt</a></li><li><a href="/finish.html" class="sidebar-link">To go further</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="step-2-install-a-service-worker"><a href="#step-2-install-a-service-worker" class="header-anchor">#</a> Step 2 : Install a Service Worker</h1> <p>Before delving into service workers, let's first understand what are web workers.</p> <h2 id="introduction-to-web-workers"><a href="#introduction-to-web-workers" class="header-anchor">#</a> Introduction to Web workers</h2> <p>As you may know, JavaScript is single threaded and does not allow the creation of threads.
A web worker allows to execute code in a separate thread for general use.
The code of the web worker generally resides in a separate JavaScript file that is loaded form the main JavaScript code.
After creating the web worker, we have two JavaScript threads: the main JavaScript thread and the worker thread.
Once the web worker is created, it can interact with the main JavaScript in a two-way fashion by using the postMessage function.</p> <p>Since the web worker has its own thread, it can perform process-heavy tasks without freezing the page.</p> <p>Here is a minimal web page that created a service worker and communicates with it.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Web worker example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendMessageToWorker()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Post message to worker<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>askWorkerToPerformRecurringTask()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Launch recurring task<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">&gt;</span></span>Worker result<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Here is the code of the main JavaScript that creates the worker and sends / receives  messages to / from it.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// crate a worker whose code is defined in the file passed as parameter </span>
<span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;worker.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">askWorkerToPerformRecurringTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// post a sting to the worker</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;recurring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">sendMessageToWorker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// post a sting to the worker</span>
    worker<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This event is fired when the worker posts a message</span>
<span class="token comment">// The value of the message is in messageEvent.data</span>
worker<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">messageEvent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;result&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Log the received message on the top of the tag</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> messageEvent<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">&quot;&lt;br&gt;&quot;</span> <span class="token operator">+</span> div<span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Finally, here is the code of the web worker that reacts to the message recieved from the main JS by either posting back a single message or by posting a random number each second.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a function that generates a random number every second and posts it to the main JavaScript</span>
<span class="token keyword">function</span> <span class="token function">generateNumbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// post a message to the main JavaScript</span>
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// This event is fired when the worker recieves a message from the main JavaScript</span>
<span class="token comment">// The value of the message is in messageEvent.data</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">messageEvent</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>messageEvent<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">&quot;recurring&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// If the value of the event is &quot;recurring&quot;, we launch the above function</span>
        <span class="token function">generateNumbers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment">// Post a message back to the main JS</span>
        self<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello to you too !&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This concludes this simple introduction to web workers. We can play with service workers next.</p> <h2 id="service-workers"><a href="#service-workers" class="header-anchor">#</a> Service workers</h2> <p>A <a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">Service Worker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a type of web worker that serve as a proxy between the browser and the network.
It has a fairly large API with a lot of potential.
In the context of a PWA, a Service Worker will mainly allow us to define a caching strategy and thus better manage unstable connections, or even get a complete offline mode for our application.</p> <p>What you should know about Service Workers:</p> <ul><li>They are workers coded in JavaScript. They run in their own thread, separated from the application, and can not access the DOM or global variables. But the app and worker can communicate through the <code>postMessage</code> API.</li> <li>These can act like programmable network proxies: they can intercept network requests from the browser and customize the responses.</li> <li>Their life cycle is independent of the associated web application: they automatically stop when not in use and restart when needed.</li> <li>They can work even when the associated web application is not running, allowing some new features like sending push notifications.</li> <li>Several APIs are available within the Service Worker to persist data locally, for example the <a href="https://developer.mozilla.org/en/docs/Web/API/Cache" target="_blank" rel="noopener noreferrer"><strong>Cache API</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and the <a href="https://developer.mozilla.org/en/docs/Web/API/API_IndexedDB" target="_blank" rel="noopener noreferrer"><strong>IndexedDB API</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li> <li>Most of the associated APIs use <a href="https://developer.mozilla.org/en/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer">Promises<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</li></ul> <p>In the <code>app</code> folder, create a new <code>sw.js</code> file. It will contain the code of your Service Worker.</p> <h2 id="registering-the-service-worker"><a href="#registering-the-service-worker" class="header-anchor">#</a> Registering the Service Worker</h2> <p>Before using a Service Worker, it must be registered by the application. The Service Worker is usually registered when the page is loaded. In the <code>scripts.js</code> file, complete the function called when the document is loaded with the following code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker
    <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">serviceWorker</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker registered: '</span> <span class="token operator">+</span> serviceWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Error registering the Service Worker: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Reload the page, the following log should appear in the console once the page loaded.</p> <div class="language-Access log extra-class"><pre class="language-text"><code>Service Worker registered: [object ServiceWorkerRegistration]
</code></pre></div><p>This means that the Service Worker has been registered. This can be verified by looking in the <strong>Application</strong> tab of Chrome Dev Tools, then the <strong>Service Workers</strong> subsection.</p> <p><img src="/assets/img/service-worker-setup.84b2c4b3.png" alt="Service Worker installed"></p> <p>We will see in the following section what happens after registering a Service Worker.</p> <h2 id="service-worker-life-cycle"><a href="#service-worker-life-cycle" class="header-anchor">#</a> Service Worker life cycle</h2> <p>When you register a Service Worker, its life cycle starts. The following diagram shows the different stages of a Service Worker's life cycle (<a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">source<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</p> <p><img src="/assets/img/sw-lifecycle.1d49eede.png" alt="Service Worker life cycle"></p> <p>The first steps are installation and activation. Let's check this by adding the following code in the <em>sw.js</em> file.</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker installing.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker activating.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Reload the page and check the logs. Curiously, we only see the installation log.</p> <div class="language- extra-class"><pre class="language-text"><code>Service Worker registered [object ServiceWorkerRegistration]
Service Worker installing.
</code></pre></div><p>Let's check what is going on in the Service Worker section of the Dev Tools. You should see something like this:</p> <p><img src="/assets/img/sw-waiting.0b9f4663.png" alt="Service Worker waiting to activate"></p> <p>When you refresh the page, the browser tries to install and activate the Service Worker with the new code. Since the latter is different from the active Service Worker, the one that has been registered at the beginning of step 2, the activation of the new one is suspended. In this case, it is put in a waiting mode and will only be installed if the previous Service Worker does not control any clients. There are two solutions in this case: either close all the tabs controlled by the first Service Worker, or click on the <strong>skipWaiting</strong> link in the dev tools.</p> <p>Click on the <strong>skipWaiting</strong> link. Notice that the former Service Worker has disappeared and that the one who was waiting took his place. The activation log is also displayed in the console.</p> <div class="language- extra-class"><pre class="language-text"><code>Service Worker activating.
</code></pre></div><p>When we refresh the page without modifying the Service Worker, we notice that we no longer go through the installation and activation steps.</p> <p>This behavior is necessary to manage version upgrades in production. In practice, you will write code in the Service Worker that manages this update process and call <code>skipWaiting</code> programmatically once everything is set up correctly.</p> <p>During development, we will keep things simple by ticking the checkbox <strong>Update on reload</strong>. This option will immediately activate future new Service Workers. It's an equivalent of an automatic click on <strong>skipWaiting</strong> each time.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Enable the <strong>Update on reload</strong> option when working on the code of a Service Worker to always have the latest version.</p> <p><img src="/assets/img/devtools-update-on-reload.d1d00b91.png" alt="Update on reload"></p> <p>However, this option will install and activate the Service Worker <strong>before</strong> displaying the page, so you won't see the logs associated with these events in console.</p></div> <h2 id="pwa-compatibility-library"><a href="#pwa-compatibility-library" class="header-anchor">#</a> PWA compatibility library</h2> <p>Progressive Web Apps is a new and evolving technology.
Some browsers do not support yet some PWA features. For example, there is not splash-screen support in mobile Safari 12.
<a href="https://github.com/GoogleChromeLabs/pwacompat" target="_blank" rel="noopener noreferrer">pwacomat<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from Google Chrome Labs fixes this by simply adding a script tag in the html file.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">async</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>https://cdn.jsdelivr.net/npm/pwacompat@2.0.8/pwacompat.min.js<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">integrity</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sha384-uONtBTCBzHKF84F6XvyC8S0gL8HTkAPeCyBNvfLfsqHh+Kd6s/kaS4BdmNQ5ktp1<span class="token punctuation">&quot;</span></span>
    <span class="token attr-name">crossorigin</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>anonymous<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>We strongly recommend to add this script for your PWAs for better compatibility.</p> <h2 id="local-development-with-ssl"><a href="#local-development-with-ssl" class="header-anchor">#</a> Local development with SSL</h2> <p>PWA requires HTTPS fully function. This not a big matter for a deployed PWA because most web hosts provide HTTPS out of the box. However, it is not the case for local development. In fact, it requires manually generating and installing certificates to the certificate store. Fortunately, there is a cool CLI tool called <a href="https://mkcert.dev/" target="_blank" rel="noopener noreferrer">mkcert<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> that simplifies these steps.</p> <p>Let's setup our local HTTPS server by following these steps:</p> <ul><li>Install <a href="https://github.com/FiloSottile/mkcert#installation" target="_blank" rel="noopener noreferrer">mkcert<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as indicated in its GitHub page</li> <li>Run <code>mkcert -install</code> to install a local CA (Certification authority)</li></ul> <div class="language-console extra-class"><pre class="language-text"><code>Created a new local CA at &quot;/Users/****/Library/Application Support/mkcert&quot; 💥
The local CA is now installed in the system trust store! ⚡️
The local CA is now installed in the Firefox trust store (requires browser restart)! 🦊
</code></pre></div><ul><li>cd to the website root</li> <li>Run this command that generated certificated for our server: <code>mkcert localhost 127.0.0.1 ::1</code></li></ul> <div class="language-console extra-class"><pre class="language-text"><code>Using the local CA at &quot;/Users/****yassinebenabbas****/Library/Application Support/mkcert&quot; ✨

Created a new certificate valid for the following names 📜
 - &quot;localhost&quot;
 - &quot;127.0.0.1&quot;
 - &quot;::1&quot;

The certificate is at &quot;./localhost+2.pem&quot; and the key at &quot;./localhost+2-key.pem&quot; ✅
</code></pre></div><ul><li>We will get two pem files. These will be used by our SSL enabled dev server.</li></ul> <p><img src="/assets/img/certs.7e43f7a2.png" alt="certs"></p> <ul><li>Install npm package <code>http-server</code></li> <li>Run the server in SSL mode <code>http-server -S -o -C &quot;localhost+2.pem&quot; -K &quot;localhost+2-key.pem&quot;</code></li></ul> <p><img src="/assets/img/certok.41829eb4.png" alt="certs"></p> <p>In this part, we saw how to install a Service Worker, and how to manage two Service Worker lifecycle events: <strong>install</strong> and <strong>activate</strong>. Now, let's see how to do something useful with this Service Worker.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/1-manifest/" class="prev">1. Adding a Web App Manifest</a></span> <span class="next"><a href="/3-precaching/">3. Precaching and basic offline mode</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9dc9a76.js" defer></script><script src="/assets/js/3.c69d9a44.js" defer></script><script src="/assets/js/5.fba207a2.js" defer></script>
  </body>
</html>
