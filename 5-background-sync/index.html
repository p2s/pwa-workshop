<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>5. Background sync and notifications | PWA Workshop</title>
    <meta name="description" content="Introduction to Progressive Web Applications">
    <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.aa2ecf69.css" as="style"><link rel="preload" href="/assets/js/app.d9dc9a76.js" as="script"><link rel="preload" href="/assets/js/3.c69d9a44.js" as="script"><link rel="preload" href="/assets/js/20.2fc7ff0c.js" as="script"><link rel="prefetch" href="/assets/js/1.70248c23.js"><link rel="prefetch" href="/assets/js/10.4a2f255d.js"><link rel="prefetch" href="/assets/js/11.27680d75.js"><link rel="prefetch" href="/assets/js/12.3eef7c77.js"><link rel="prefetch" href="/assets/js/13.7f52cf31.js"><link rel="prefetch" href="/assets/js/14.375a1e21.js"><link rel="prefetch" href="/assets/js/15.349dce31.js"><link rel="prefetch" href="/assets/js/16.5c7d3d8b.js"><link rel="prefetch" href="/assets/js/17.b0821c4d.js"><link rel="prefetch" href="/assets/js/18.b5485965.js"><link rel="prefetch" href="/assets/js/19.f2ff2149.js"><link rel="prefetch" href="/assets/js/21.02740876.js"><link rel="prefetch" href="/assets/js/22.6ed05f9f.js"><link rel="prefetch" href="/assets/js/23.cb63fa5d.js"><link rel="prefetch" href="/assets/js/24.e5dfe154.js"><link rel="prefetch" href="/assets/js/4.15820eac.js"><link rel="prefetch" href="/assets/js/5.fba207a2.js"><link rel="prefetch" href="/assets/js/6.e17a1400.js"><link rel="prefetch" href="/assets/js/7.a2e3be9a.js"><link rel="prefetch" href="/assets/js/8.8f8d29be.js"><link rel="prefetch" href="/assets/js/9.363b16b9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.aa2ecf69.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">PWA Workshop</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/5-background-sync/" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/5-background-sync/" class="nav-link">Français</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://pwa-cookbook.js.org" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Cookbook
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/sylvainpolletvillard/pwa-workshop" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Language</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/5-background-sync/" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/fr/5-background-sync/" class="nav-link">Français</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Adding a Web App Manifest</a></li><li><a href="/2-service-worker/" class="sidebar-link">2. Install a Service Worker</a></li><li><a href="/3-precaching/" class="sidebar-link">3. Precaching and basic offline mode</a></li><li><a href="/4-api-cache/" class="sidebar-link">4. Cache Strategy for REST API</a></li><li><a href="/5-background-sync/" class="active sidebar-link">5. Background sync and notifications</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/5-background-sync/#notifications-and-permissions" class="sidebar-link">Notifications and permissions</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#background-synchronization" class="sidebar-link">Background Synchronization</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#update-and-notification" class="sidebar-link">Update and notification</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#testing" class="sidebar-link">Testing</a></li></ul></li><li><a href="/6-pwa-setup/" class="sidebar-link">6. Showing the install button prompt</a></li><li><a href="/finish.html" class="sidebar-link">To go further</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="step-5-background-sync-and-notifications"><a href="#step-5-background-sync-and-notifications" class="header-anchor">#</a> Step 5 : Background sync and notifications</h1> <p>In this step, we will use the Service Worker and a new API, <strong>Background Sync</strong>, to update the list of attendees in the background and notify the user when there are new attendees.</p> <div class="custom-block danger"><p class="custom-block-title">Non-standard</p> <p>The Background Sync API is not yet standardized. The <a href="https://wicg.github.io/BackgroundSync/spec/" target="_blank" rel="noopener noreferrer">specification<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is still under study. It has already been implemented on Chrome and Android since 2016, and is under development on Edge and Firefox. This API distinguishes two types of synchronization: * One-Time * and * Periodic *. Currently, only <strong>One-Time</strong> synchronization is implemented in Chrome, and there may be some implementation bugs.</p></div> <p>Regarding notifications, the Push API allows web applications to receive push notifications pushed from a server, even when the web application is not in the foreground and even when it is not currently loaded on the user system. Nevertheless, this implies the use of a server-side push service such as Google Cloud Messenger.
 
During this workshop, we will not use the Push API but the <strong>Notification API</strong>. This API also allows you to send notifications without requiring a server part, but requires the browser to be open. These notifications are multi-platform, so they will adapt to the target platform: Android notifications or the notification center of Windows 10 for example.</p> <h2 id="notifications-and-permissions"><a href="#notifications-and-permissions" class="header-anchor">#</a> Notifications and permissions</h2> <p>Synchronization in the background does not require special permissions, but posting notifications requires the user's consent. To avoid spam, browsers have added constraints to be able to request these permissions. For example, we can do this after a specific user action such as clicking on a link.</p> <p>So add this link below somewhere in the <code>index.html</code> page to enable notifications:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>registerNotification()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Notify me when there are new attendees<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Then declare the following function in <code>scripts.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token parameter">permission</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">registerBackgroundSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
		<span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Permission was not granted.&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>When the user has given permission to display notifications, we will call the <code>registerBackgroundSync</code> function to set up background synchronization.</p> <h2 id="background-synchronization"><a href="#background-synchronization" class="header-anchor">#</a> Background Synchronization</h2> <p>The client must explicitly register for synchronization tasks in the background. To do this, we first retrieve a reference to the <code>ServiceWorkerRegistration</code>, which represents the registration link between your Service Worker and your client. The simplest way to do this is to use [<code>navigator.serviceWorker.ready</code>] (https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/ready) which returns a<code>Promise</code> resolved with the <code>ServiceWorkerRegistration</code> when the Service Worker is installed and running.</p> <p>Once the <code>registration</code> object of type <code>ServiceWorkerRegistration</code> is retrieved, we can call the <code>registration.sync.register</code> method to register for a One-Time synchronization task in the background.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerBackgroundSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Service Worker not supported&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> registration<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'syncAttendees'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Registered background sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error registering background sync&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>On the Service Worker side, a <code>sync</code> event will be emitted when the system decides to trigger a synchronization. This decision is based on various parameters: connectivity, battery status, power source, etc. ; so we can not be sure when synchronization will be triggered. The specification is planning for future parameterization options, but for now, all we can do is wait. However, under the conditions of this workshop, this should only take a few seconds.</p> <div class="language-js extra-class"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sync event&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'syncAttendees'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">syncAttendees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sending sync request</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="update-and-notification"><a href="#update-and-notification" class="header-anchor">#</a> Update and notification</h2> <p>The synchronization request is similar to the <code>update</code> and<code>refresh</code> at step 4, except that it is requested by the system and not the client:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">syncAttendees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://reqres.in/api/users</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>refresh<span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">attendees</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>
    		<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attendees<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> attendees to the PWA Workshop</span><span class="token template-punctuation string">`</span></span>
    	<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>If the client has permission to view notifications, the <code>self.registration.showNotification</code> method should display a notification with the desired text on the registered client.</p> <h2 id="testing"><a href="#testing" class="header-anchor">#</a> Testing</h2> <div class="custom-block warning"><p class="custom-block-title">Warning</p> <p>As with the previous steps, make sure that the <strong>Update on reload</strong> box is checked in the Developer Tools to always reload the latest version of the Service Worker.</p></div> <p>When clicking on the notifications activation link, a request for permission should be displayed. After accepting, you should observe <code>Registered background sync</code> in the console. All you have to do is wait until the system triggers a synchronization and displays the notification, which should take a few seconds, 1 minute at most. If the web application is in the foreground, the list of participants should also be updated with the <code>refresh</code> function in<code>syncAttendees</code>.</p> <p>You can click the notification link again to request a new sync.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/4-api-cache/" class="prev">4. Cache Strategy for REST API</a></span> <span class="next"><a href="/6-pwa-setup/">6. Showing the install button prompt</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d9dc9a76.js" defer></script><script src="/assets/js/3.c69d9a44.js" defer></script><script src="/assets/js/20.2fc7ff0c.js" defer></script>
  </body>
</html>
